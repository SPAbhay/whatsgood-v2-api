<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>whatsgood - Your AI News Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        /* Simple spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

    <div class="container mx-auto max-w-3xl p-4 pt-12">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold text-white mb-2">whatsgood</h1>
            <p class="text-lg text-gray-400">Your Personal AI-Powered News Analyst</p>
        </header>

        <section id="persona-section" class="mb-8">
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <label for="persona-input" class="block text-sm font-medium text-gray-300 mb-2">1. Set Your Persona</label>
                <textarea id="persona-input" rows="3" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'An AI engineer in London interested in MLOps, RAG, and new Python libraries...'"></textarea>
                <button id="set-persona-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                    <span id="set-persona-text">Save Persona & Get Recs</span>
                    <div id="set-persona-spinner" class="spinner hidden"></div>
                </button>
                <p id="persona-status" class="text-green-400 text-sm mt-2 text-center"></p>
            </div>
        </section>

        <section id="recs-section" class="hidden">
            <h2 class="text-2xl font-semibold text-white mb-4">Your Top 5 Recommendations</h2>
            <div id="recs-output" class="space-y-6">
                </div>
            <p id="recs-error" class="text-red-400 text-center mt-4"></p>
        </section>
    </div>

    <template id="article-template">
        <div class="article-card bg-gray-800 rounded-lg shadow-lg overflow-hidden transition duration-300 hover:shadow-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="industry-tag text-xs font-medium bg-blue-900 text-blue-200 py-1 px-3 rounded-full uppercase"></span>
                    <span class="published-date text-xs text-gray-500"></span>
                </div>
                <h3 class="text-xl font-bold text-white mb-3">
                    <a href="" target="_blank" rel="noopener noreferrer" class="article-title hover:underline"></a>
                </h3>
                <p class="article-summary text-gray-300 mb-5"></p>
                <div class="flex justify-end space-x-3">
                    <button class="like-btn p-2 rounded-full text-gray-400 hover:bg-green-800 hover:text-green-300 transition duration-200" title="Like">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.323-.033-.472-.094l-3.64-1.82A2 2 0 016 17.218V8a2 2 0 012-2h2l1.657-3.314a1 1 0 011.686.838l-1.344 2.688A2 2 0 0112 7h2z"></path></svg>
                    </button>
                    <button class="dislike-btn p-2 rounded-full text-gray-400 hover:bg-red-800 hover:text-red-300 transition duration-200" title="Dislike">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.737 3h4.017c.163 0 .323.033.472.094l3.64 1.82A2 2 0 0118 6.782V16a2 2 0 01-2 2h-2l-1.657 3.314a1 1 0 01-1.686-.838l1.344-2.688A2 2 0 0112 17h-2z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- CONFIGURATION ---
        // This is your live, production API
        const API_BASE_URL = "https://api-whatsgood.abhay-arora.com"; 
        
        // This is your test User ID
        // In a real app, you'd get this from an auth system.
        const USER_ID = "19c467ac-a9a1-47ac-9987-ba0b5a02a4bf"; 

        // --- DOM ELEMENTS ---
        const personaInput = document.getElementById('persona-input');
        const setPersonaBtn = document.getElementById('set-persona-btn');
        const setPersonaText = document.getElementById('set-persona-text');
        const setPersonaSpinner = document.getElementById('set-persona-spinner');
        const personaStatus = document.getElementById('persona-status');
        
        const recsSection = document.getElementById('recs-section');
        const recsOutput = document.getElementById('recs-output');
        const recsError = document.getElementById('recs-error');
        const articleTemplate = document.getElementById('article-template');

        // --- EVENT LISTENERS ---
        setPersonaBtn.addEventListener('click', handleGetRecommendations);

        // --- API FUNCTIONS ---

        // 1. Set Persona
        async function setPersona(personaText) {
            personaStatus.textContent = "";
            const response = await fetch(`${API_BASE_URL}/persona`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: USER_ID,
                    persona: personaText
                })
            });
            if (!response.ok) throw new Error("Failed to set persona.");
            return await response.json();
        }

        // 2. Get Recommendations
        async function getRecommendations() {
            recsError.textContent = "";
            const response = await fetch(`${API_BASE_URL}/recommendations?user_id=${USER_ID}`);
            if (!response.ok) throw new Error("Failed to get recommendations.");
            return await response.json();
        }

        // 3. Post Interaction (Like/Dislike)
        async function postInteraction(articleId, interactionType) {
            await fetch(`${API_BASE_URL}/interact`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: USER_ID,
                    article_id: articleId,
                    interaction_type: interactionType
                })
            });
        }

        // --- MAIN LOGIC ---

        // Main function to run the pipeline
        async function handleGetRecommendations() {
            const personaText = personaInput.value;
            if (!personaText) {
                alert("Please enter a persona.");
                return;
            }

            setLoading(true);
            clearRecommendations();

            try {
                // Step 1: Set the persona
                console.log("Setting persona...");
                await setPersona(personaText);
                personaStatus.textContent = "Persona updated successfully!";

                // Step 2: Get recommendations
                console.log("Getting recommendations...");
                const data = await getRecommendations();

                // Step 3: Render
                if (data.recommendations && data.recommendations.length > 0) {
                    renderRecommendations(data.recommendations);
                } else {
                    recsError.textContent = "No recommendations found.";
                }

            } catch (err) {
                console.error(err);
                recsError.textContent = `Error: ${err.message}`;
            } finally {
                setLoading(false);
            }
        }

        // --- UI HELPER FUNCTIONS ---

        function setLoading(isLoading) {
            if (isLoading) {
                setPersonaText.classList.add('hidden');
                setPersonaSpinner.classList.remove('hidden');
                setPersonaBtn.disabled = true;
            } else {
                setPersonaText.classList.remove('hidden');
                setPersonaSpinner.classList.add('hidden');
                setPersonaBtn.disabled = false;
            }
        }

        function clearRecommendations() {
            recsOutput.innerHTML = "";
            recsSection.classList.add('hidden');
        }
        
        function formatSimpleDate(isoDate) {
            try {
                return new Date(isoDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch(e) {
                return "Someday";
            }
        }

        function renderRecommendations(articles) {
            recsSection.classList.remove('hidden');
            articles.forEach(article => {
                const card = document.importNode(articleTemplate.content, true);
                
                // Populate card
                card.querySelector('.industry-tag').textContent = article.industry;
                card.querySelector('.published-date').textContent = formatSimpleDate(article.published_date);
                card.querySelector('.article-title').textContent = article.title;
                card.querySelector('.article-title').href = article.url;
                card.querySelector('.article-summary').textContent = article.summary;

                // Add click events for like/dislike
                const likeBtn = card.querySelector('.like-btn');
                const dislikeBtn = card.querySelector('.dislike-btn');
                const articleCard = card.querySelector('.article-card');

                likeBtn.addEventListener('click', () => {
                    handleInteraction(article.id, 'like', articleCard, [likeBtn, dislikeBtn]);
                });

                dislikeBtn.addEventListener('click', () => {
                    handleInteraction(article.id, 'dislike', articleCard, [likeBtn, dislikeBtn]);
                });
                
                recsOutput.appendChild(card);
            });
        }

        async function handleInteraction(articleId, type, card, buttons) {
            try {
                // Send interaction to backend
                await postInteraction(articleId, type);
                
                // Visual feedback
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-20', 'cursor-not-allowed');
                });
                
                if (type === 'like') {
                    card.classList.add('border-2', 'border-green-500');
                } else {
                    card.classList.add('border-2', 'border-red-500', 'opacity-50');
                }

                
            } catch (err) {
                console.error("Failed to post interaction", err);
            }
        }

    </script>
</body>
</html>
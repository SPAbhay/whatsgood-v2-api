<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>whatsgood - Your AI News Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        /* Card Stack Styles */
        .card-stack {
            position: relative;
            width: 90vw;
            height: 65vh;
            max-width: 400px;
            max-height: 500px;
            margin: auto;
        }
        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            background: #1F2937; /* bg-gray-800 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: grab;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .swipe-card.dragging {
            transition: none;
            cursor: grabbing;
        }
        .swipe-card .like-badge, .swipe-card .dislike-badge {
            position: absolute;
            top: 20px;
            font-size: 2rem;
            font-weight: bold;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .swipe-card .like-badge {
            left: 20px;
            color: #10B981; /* green-500 */
            border: 4px solid #10B981;
            transform: rotate(-20deg);
        }
        .swipe-card .dislike-badge {
            right: 20px;
            color: #EF4444; /* red-500 */
            border: 4px solid #EF4444;
            transform: rotate(20deg);
        }
        .swipe-card.dragging .like-badge {
            opacity: var(--like-opacity, 0);
        }
        .swipe-card.dragging .dislike-badge {
            opacity: var(--dislike-opacity, 0);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for expanded article */
        .expanded-content {
            height: 100%;
            overflow-y: auto;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen font-sans overflow-hidden">

    <div id="login-screen" class="container mx-auto max-w-sm p-4 pt-20 text-center hidden">
        <h1 class="text-5xl font-bold text-white mb-4">whatsgood</h1>
        <p class="text-lg text-gray-400 mb-8">Enter your Beta API Key to log in.</p>
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <input id="api-key-input" type="password" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your API Key">
            <button id="login-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">
                Login
            </button>
            <p id="login-error" class="text-red-400 text-sm mt-3"></p>
        </div>
    </div>

    <div id="dashboard-screen" class="flex flex-col h-screen max-h-[-webkit-fill-available] hidden">
        
        <header class="flex justify-between items-center p-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white">whatsgood</h1>
            <button id="logout-btn" class="text-gray-400 hover:text-white">Logout</button>
        </header>

        <main class="flex-1 flex flex-col items-center justify-center p-4 overflow-hidden">
            
            <div id="persona-setup" class="w-full max-w-md p-6 bg-gray-800 rounded-lg shadow-lg text-center hidden">
                <h2 class="text-2xl font-semibold mb-4">Welcome!</h2>
                <p class="text-gray-300 mb-6">Set your persona to get your first recommendations.</p>
                <textarea id="persona-input" rows="4" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'An AI engineer in London...'"></textarea>
                <button id="save-persona-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">
                    Save Persona & Start
                </button>
            </div>

            <div id="recommendations-container" class="hidden w-full">
                <div id="card-stack" class="card-stack">
                    <div id="loading-spinner" class="spinner absolute top-1/2 left-1/2 -mt-4 -ml-4"></div>
                    <div id="end-of-stack" class="hidden text-center text-gray-400 p-8">
                        <h3 class="text-2xl font-semibold mb-4">You're all caught up!</h3>
                        <p class="mb-6">You've seen all 5 recommendations. New recommendations will be available after your next refresh (10 per day).</p>
                        <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">
                            Refresh Now
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <footer id="footer-dashboard" class="p-4 border-t border-gray-700 hidden">
            <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Recent Interactions</h3>
            <div id="recent-interactions" class="flex space-x-4 overflow-x-auto pb-2">
                <p id="no-interactions" class="text-gray-500 text-sm">No recent interactions yet.</p>
            </div>
        </footer>
    </div>

    <template id="article-template">
        <div class="swipe-card" data-id="">
            <div class="card-content p-6 flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-2">
                    <span class="industry-tag text-xs font-medium bg-blue-900 text-blue-200 py-1 px-3 rounded-full uppercase"></span>
                    <span class="published-date text-xs text-gray-500"></span>
                </div>
                <h3 class="article-title text-2xl font-bold text-white mb-4"></h3>
                <p class="article-summary text-gray-300 text-lg"></p>
                <p class="article-reason text-gray-400 text-sm italic mt-4 hidden"></p>
            </div>
            <div class="like-badge">LIKE</div>
            <div class="dislike-badge">NOPE</div>
            
            <div class="expanded-content hidden">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4"></h3>
                    <p class="text-gray-300 mb-4"></p>
                    <p class="text-gray-400 text-sm italic mb-6 border-l-2 border-blue-500 pl-4"></p>
                    <a href="" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        Read Full Article
                    </a>
                </div>
                <button class="close-expanded-btn mt-6 text-gray-400 hover:text-white">Close</button>
            </div>
        </div>
    </template>

<script>
// === CONFIG ===
const API_BASE_URL = "https://api-whatsgood.abhay-arora.com";

// === STATE ===
let API_KEY = null;
let USER_ID = null;
let currentArticles = [];

// === DOM ELEMENTS ===
const loginScreen = document.getElementById('login-screen');
const dashboardScreen = document.getElementById('dashboard-screen');
const apiKeyInput = document.getElementById('api-key-input');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');
const logoutBtn = document.getElementById('logout-btn');
const personaSetup = document.getElementById('persona-setup');
const personaInput = document.getElementById('persona-input');
const savePersonaBtn = document.getElementById('save-persona-btn');
const recsContainer = document.getElementById('recommendations-container');
const cardStack = document.getElementById('card-stack');
const loadingSpinner = document.getElementById('loading-spinner');
const endOfStack = document.getElementById('end-of-stack');
const refreshBtn = document.getElementById('refresh-btn');
const footerDashboard = document.getElementById('footer-dashboard');
const recentInteractions = document.getElementById('recent-interactions');
const noInteractions = document.getElementById('no-interactions');
const articleTemplate = document.getElementById('article-template');

// === API CLIENT ===
class ApiClient {
    constructor() {
        this.apiKey = localStorage.getItem('whatsgood_api_key');
        this.userId = localStorage.getItem('whatsgood_user_id');
    }

    async login(key) {
        const res = await this.request('/login', 'POST', null, { api_key: key });
        this.apiKey = key;
        this.userId = res.user_id;
        localStorage.setItem('whatsgood_api_key', key);
        localStorage.setItem('whatsgood_user_id', res.user_id);
        return res;
    }

    logout() {
        this.apiKey = null;
        this.userId = null;
        localStorage.removeItem('whatsgood_api_key');
        localStorage.removeItem('whatsgood_user_id');
    }

    isLoggedIn() {
        return !!this.apiKey;
    }

    async getMe() {
        return this.request('/me', 'GET');
    }

    async setPersona(persona) {
        return this.request('/persona', 'POST', { user_id: this.userId, persona });
    }

    async getRecommendations() {
        return this.request(`/recommendations?user_id=${this.userId}`, 'GET');
    }

    async postInteraction(articleId, interactionType) {
        return this.request('/interact', 'POST', { user_id: this.userId, article_id: articleId, interaction_type: interactionType });
    }

    async request(endpoint, method, body = null, unauthData = null) {
        const headers = { 'Content-Type': 'application/json' };
        if (this.apiKey) {
            headers['x-api-key'] = this.apiKey;
        }

        const config = {
            method,
            headers
        };

        if (body) {
            config.body = JSON.stringify(body);
        } else if (unauthData) {
            config.body = JSON.stringify(unauthData);
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

        if (response.status === 403) {
            throw new Error("Invalid API Key or Quota Exceeded.");
        }
        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }
        return await response.json();
    }
}

const api = new ApiClient();

// === APP LOGIC ===

function initApp() {
    if (api.isLoggedIn()) {
        showDashboard();
    } else {
        showLogin();
    }
}

function showLogin() {
    dashboardScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
}

async function showDashboard() {
    loginScreen.classList.add('hidden');
    dashboardScreen.classList.remove('hidden');

    try {
        const me = await api.getMe();
        USER_ID = me.user_id;
        renderRecentInteractions(me.recent_interactions);
        
        if (!me.base_persona) {
            // New user: Show persona setup
            recsContainer.classList.add('hidden');
            footerDashboard.classList.add('hidden');
            personaSetup.classList.remove('hidden');
        } else {
            // Existing user: Show recs
            personaInput.value = me.base_persona; // Pre-fill just in case
            personaSetup.classList.add('hidden');
            recsContainer.classList.remove('hidden');
            footerDashboard.classList.remove('hidden');
            loadRecommendations();
        }
    } catch (err) {
        console.error(err);
        alert(`Error: ${err.message}. Logging out.`);
        api.logout();
        showLogin();
    }
}

async function handleLogin() {
    const key = apiKeyInput.value;
    if (!key) return;
    
    loginError.textContent = "";
    try {
        await api.login(key);
        showDashboard();
    } catch (err) {
        console.error(err);
        loginError.textContent = err.message;
    }
}

async function handleSavePersona() {
    const persona = personaInput.value;
    if (!persona) return;

    try {
        await api.setPersona(persona);
        showDashboard(); // Reload dashboard
    } catch (err) {
        alert(`Error saving persona: ${err.message}`);
    }
}

async function loadRecommendations() {
    cardStack.innerHTML = ''; // Clear old cards
    endOfStack.classList.add('hidden');
    loadingSpinner.classList.remove('hidden');

    try {
        const data = await api.getRecommendations();
        currentArticles = data.recommendations;
        loadingSpinner.classList.add('hidden');
        
        if (currentArticles.length > 0) {
            renderCardStack();
        } else {
            endOfStack.classList.remove('hidden');
        }
    } catch (err) {
        console.error(err);
        loadingSpinner.classList.add('hidden');
        endOfStack.classList.remove('hidden');
        endOfStack.querySelector('p').textContent = `Error: ${err.message}`;
    }
}

function renderCardStack() {
    currentArticles.reverse().forEach((article, index) => {
        const card = createCardElement(article);
        card.style.zIndex = index;
        card.style.transform = `translateY(${index * -10}px)`;
        cardStack.appendChild(card);
    });

    const topCard = cardStack.lastChild;
    if (topCard) {
        initSwipe(topCard);
    }
}

function createCardElement(article) {
    const card = articleTemplate.content.cloneNode(true).firstElementChild;
    card.dataset.id = article.id;
    card.dataset.url = article.url;
    card.dataset.reason = article.reason; // Store reason

    card.querySelector('.industry-tag').textContent = article.industry;
    card.querySelector('.published-date').textContent = new Date(article.published_date).toLocaleDateString();
    card.querySelector('.article-title').textContent = article.title;
    card.querySelector('.article-summary').textContent = article.summary;
    card.querySelector('.article-reason').textContent = article.reason; // For expanded view

    // Populate expanded view
    const expandedContent = card.querySelector('.expanded-content');
    expandedContent.querySelector('h3').textContent = article.title;
    expandedContent.querySelector('p:first-of-type').textContent = article.summary;
    expandedContent.querySelector('p:last-of-type').textContent = article.reason;
    expandedContent.querySelector('a').href = article.url;

    // Add click to expand
    card.querySelector('.card-content').addEventListener('click', () => {
        if (!card.classList.contains('dragging')) {
            card.querySelector('.card-content').classList.add('hidden');
            expandedContent.classList.remove('hidden');
        }
    });
    
    card.querySelector('.close-expanded-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        card.querySelector('.card-content').classList.remove('hidden');
        expandedContent.classList.add('hidden');
    });

    return card;
}

function initSwipe(card) {
    const gesture = new Hammer(card);
    const likeBadge = card.querySelector('.like-badge');
    const dislikeBadge = card.querySelector('.dislike-badge');
    const screenWidth = window.innerWidth;

    // We only care about horizontal panning
    gesture.get('pan').set({ direction: Hammer.DIRECTION_HORIZONTAL });

    gesture.on('panstart', () => {
        if (card.querySelector('.expanded-content').classList.contains('hidden')) {
            card.classList.add('dragging');
        }
    });

    gesture.on('panmove', (e) => {
        if (!card.classList.contains('dragging')) return;
        
        const rotation = e.deltaX * 0.05;
        card.style.transform = `translateX(${e.deltaX}px) rotate(${rotation}deg)`;
        
        const likeOpacity = e.deltaX > 0 ? (e.deltaX / (screenWidth / 4)) : 0;
        const dislikeOpacity = e.deltaX < 0 ? (Math.abs(e.deltaX) / (screenWidth / 4)) : 0;
        card.style.setProperty('--like-opacity', likeOpacity);
        card.style.setProperty('--dislike-opacity', dislikeOpacity);
    });

    gesture.on('panend', (e) => {
        card.classList.remove('dragging');
        card.style.setProperty('--like-opacity', 0);
        card.style.setProperty('--dislike-opacity', 0);

        if (Math.abs(e.deltaX) > 100) {
            // Swipe threshold met
            const direction = e.deltaX > 0 ? 'right' : 'left';
            const interaction = direction === 'right' ? 'like' : 'dislike';
            
            card.style.transform = `translateX(${direction === 'right' ? screenWidth : -screenWidth}px) rotate(${direction === 'right' ? 30 : -30}deg)`;
            card.style.opacity = 0;
            
            handleSwipe(card.dataset.id, interaction);
            
            setTimeout(() => {
                card.remove(); // First, remove the swiped card from the DOM
                
                // NOW, find the new top card
                const nextCard = cardStack.lastChild; 
                if (nextCard) {
                    // Attach swipe listener to the new top card
                    initSwipe(nextCard); 
                } else {
                    // No cards left, show the end message
                    endOfStack.classList.remove('hidden');
                }
            }, 300);
        } else {
            // Return to stack
            card.style.transform = `translateY(${parseInt(card.style.zIndex) * -10}px)`;
        }
    });
}

async function handleSwipe(articleId, interactionType) {
    console.log(`Swiped ${interactionType} on article ${articleId}`);
    try {
        await api.postInteraction(articleId, interactionType);
        // Refresh recent interactions in the footer
        // const me = await api.getMe();
        // renderRecentInteractions(me.recent_interactions);
    } catch (err) {
        console.error(`Failed to post interaction: ${err.message}`);
    }
}

function renderRecentInteractions(interactions) {
    recentInteractions.innerHTML = ''; // Clear
    if (!interactions || interactions.length === 0) {
        noInteractions.classList.remove('hidden');
        return;
    }
    
    noInteractions.classList.add('hidden');
    interactions.forEach(item => {
        const isLike = item.interaction_type === 'like';
        const color = isLike ? 'border-green-500' : 'border-red-500';
        const icon = isLike ? 'üëç' : 'üëé';
        
        const el = document.createElement('div');
        el.className = `flex-shrink-0 w-48 p-3 bg-gray-800 rounded-md border-l-4 ${color}`;
        el.innerHTML = `
            <div class="text-xs text-gray-400 truncate">${item.articles.title}</div>
            <div class="text-sm font-semibold">${icon} ${item.interaction_type}</div>
        `;
        recentInteractions.appendChild(el);
    });
}

// === BOOTSTRAP ===
loginBtn.addEventListener('click', handleLogin);
savePersonaBtn.addEventListener('click', handleSavePersona);
refreshBtn.addEventListener('click', loadRecommendations);

logoutBtn.addEventListener('click', () => {
    api.logout();
    showLogin();
});

// Start the app
initApp();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>whatsgood - Your AI News Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        /* Card Stack Styles */
        .card-stack {
            position: relative;
            width: 90vw;
            height: 60vh; /* Slightly smaller */
            max-width: 400px;
            max-height: 450px; /* Slightly smaller */
            margin: 1rem auto;
        }
        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 1rem;
            background: #1F2937; /* bg-gray-800 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, opacity 0.3s ease;
            cursor: grab;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid transparent; /* For interaction feedback */
        }
        /* Stack effect */
        .swipe-card:nth-last-child(n+4) { display: none; } /* Show only top 3 */
        .swipe-card:nth-last-child(2) { transform: translateY(-15px) scale(0.95); opacity: 0.8; }
        .swipe-card:nth-last-child(1) { transform: translateY(-30px) scale(0.9); opacity: 0.6; }

        .swipe-card.dragging { transition: none; cursor: grabbing; }
        .swipe-card .like-badge, .swipe-card .dislike-badge { /* ... existing badge styles ... */ }
        .swipe-card.dragging .like-badge { opacity: var(--like-opacity, 0); }
        .swipe-card.dragging .dislike-badge { opacity: var(--dislike-opacity, 0); }

        .spinner { /* ... existing spinner styles ... */ }
        @keyframes spin { /* ... existing spin animation ... */ }

        .expanded-content { /* ... existing expanded content styles ... */ }

        /* Subtle glow for swipe hint */
        @keyframes subtle-glow { 0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); } 50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); } }
        .swipe-hint { animation: subtle-glow 2s infinite ease-in-out; }

        /* Tooltip for reason */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: #374151; color: #fff; padding: 5px 10px; border-radius: 4px;
            font-size: 0.8rem; white-space: normal; width: 200px; text-align: center; margin-bottom: 5px; z-index: 10;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen font-sans overflow-hidden flex flex-col">

    <div id="login-screen" class="container mx-auto max-w-sm p-4 pt-20 text-center hidden flex-1 flex flex-col justify-center">
        <h1 class="text-5xl font-bold text-white mb-4">whatsgood</h1>
        <p class="text-lg text-gray-400 mb-8">Enter your Beta API Key to log in.</p>
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <input id="api-key-input" type="password" class="w-full p-3 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Enter your API Key">
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">Login</button>
            <p id="login-error" class="text-red-400 text-sm mt-3"></p>
        </div>
    </div>

    <div id="dashboard-screen" class="flex flex-col h-screen max-h-[-webkit-fill-available] hidden">

        <header class="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
            <h1 class="text-2xl font-bold text-white">whatsgood</h1>
            <button id="logout-btn" class="text-gray-400 hover:text-white text-sm">Logout</button>
        </header>

        <main class="flex-1 flex flex-col items-center justify-start p-4 overflow-hidden">

            <div id="persona-setup" class="w-full max-w-lg p-6 bg-gray-800 rounded-lg shadow-lg text-center hidden mt-10">
                <h2 class="text-2xl font-semibold mb-3">Welcome! Let's get started.</h2>
                <p class="text-gray-300 mb-6">Tell us about yourself so we can curate relevant news.</p>
                <div class="mb-4 text-left">
                    <label for="interest-input" class="block text-sm font-medium text-gray-300 mb-1">Primary Field of Interest:</label>
                    <input id="interest-input" type="text" class="w-full p-2 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="e.g., Artificial Intelligence, Finance, Basketball">
                </div>
                <div class="mb-6 text-left">
                    <label for="persona-input" class="block text-sm font-medium text-gray-300 mb-1">Describe your specific interests (Persona):</label>
                    <textarea id="persona-input" rows="4" class="w-full p-2 bg-gray-700 text-white rounded-md border border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="e.g., 'Focusing on MLOps and RAG pipelines. Also follow European football.'"></textarea>
                </div>
                <button id="save-persona-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200">Save & View Feed</button>
            </div>

            <div id="recommendations-container" class="hidden w-full flex-1 flex flex-col justify-between">
                 <div class="text-center mt-2 mb-2 px-4">
                    <p class="text-sm text-gray-400">Swipe or use buttons to rate articles. Your feed learns from your choices.</p>
                    <p id="card-counter" class="text-xs text-gray-500 font-semibold"></p>
                </div>

                <div id="card-stack" class="card-stack">
                    <div id="loading-spinner" class="spinner absolute top-1/2 left-1/2 -mt-4 -ml-4"></div>
                    <div id="end-of-stack" class="hidden flex flex-col items-center justify-center text-center text-gray-400 p-8 bg-gray-800 rounded-lg">
                        <h3 class="text-xl font-semibold mb-3">You're all caught up!</h3>
                        <p id="end-of-stack-message" class="mb-5 text-sm"></p>
                        <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Refresh Now</button>
                    </div>
                     <div id="error-display" class="hidden flex flex-col items-center justify-center text-center text-red-400 p-8 bg-gray-800 rounded-lg">
                         <h3 class="text-xl font-semibold mb-3">Oops! Something went wrong.</h3>
                         <p id="error-message" class="mb-5 text-sm"></p>
                         <button id="retry-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Try Again</button>
                    </div>
                </div>

                 <div id="swipe-buttons" class="flex justify-center space-x-8 py-4">
                     <button id="dislike-btn" class="p-4 rounded-full bg-red-800 hover:bg-red-700 text-white shadow-lg transform transition hover:scale-110">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                     <button id="like-btn" class="p-4 rounded-full bg-green-800 hover:bg-green-700 text-white shadow-lg transform transition hover:scale-110">
                         <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
        </main>

        <footer id="footer-dashboard" class="p-4 border-t border-gray-700 hidden flex-shrink-0">
            <h3 class="text-sm font-semibold text-gray-400 uppercase mb-3">Recent Interactions</h3>
            <div id="recent-interactions" class="flex space-x-4 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-gray-800">
                <p id="no-interactions" class="text-gray-500 text-sm italic">Swipe articles to see your history here.</p>
            </div>
        </footer>
    </div>

    <template id="article-template">
        <div class="swipe-card relative" data-id="">
            <div class="card-content p-5 flex-1 overflow-y-auto">
                <div class="flex justify-between items-start mb-2">
                    <span class="industry-tag text-xs font-medium bg-blue-900 text-blue-200 py-1 px-2 rounded-full uppercase"></span>
                    <span class="published-date text-xs text-gray-500 text-right"></span>
                </div>
                <h3 class="article-title text-xl font-semibold text-white mb-3 leading-tight"></h3>
                <p class="article-summary text-gray-300 text-base"></p>
                <button class="reason-tooltip-trigger absolute bottom-4 right-4 text-gray-500 hover:text-blue-400 focus:outline-none" data-tooltip="">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                </button>
            </div>

            <div class="like-badge">LIKE</div>
            <div class="dislike-badge">NOPE</div>

            <div class="expanded-content hidden">
                <div>
                    <h3 class="expanded-title text-2xl font-bold text-white mb-4"></h3>      <p class="expanded-summary text-gray-300 mb-4"></p>                     <p class="expanded-reason text-gray-400 text-sm italic mb-6 border-l-2 border-blue-500 pl-4"></p> <a href="" target="_blank" rel="noopener noreferrer" class="expanded-link inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200"> Read Full Article
                    </a>
                </div>
                <button class="close-expanded-btn mt-6 text-gray-400 hover:text-white self-center">Close</button> </div>
        </div>
    </template>

<script>
// === CONFIG ===
const API_BASE_URL = "https://api-whatsgood.abhay-arora.com";
const MAX_CARDS_PER_SESSION = 5;

// === STATE ===
let currentArticles = [];
let currentCardIndex = 0;

// === DOM ELEMENTS === (Mostly unchanged, added new ones)
const loginScreen = document.getElementById('login-screen');
const dashboardScreen = document.getElementById('dashboard-screen');
const apiKeyInput = document.getElementById('api-key-input');
const loginBtn = document.getElementById('login-btn');
const loginError = document.getElementById('login-error');
const logoutBtn = document.getElementById('logout-btn');
const personaSetup = document.getElementById('persona-setup');
const interestInput = document.getElementById('interest-input'); // New
const personaInput = document.getElementById('persona-input');
const savePersonaBtn = document.getElementById('save-persona-btn');
const recsContainer = document.getElementById('recommendations-container');
const cardCounter = document.getElementById('card-counter'); // New
const cardStack = document.getElementById('card-stack');
const loadingSpinner = document.getElementById('loading-spinner');
const endOfStack = document.getElementById('end-of-stack');
const endOfStackMessage = document.getElementById('end-of-stack-message'); // New
const refreshBtn = document.getElementById('refresh-btn');
const errorDisplay = document.getElementById('error-display'); // New
const errorMessage = document.getElementById('error-message'); // New
const retryBtn = document.getElementById('retry-btn'); // New
const swipeButtons = document.getElementById('swipe-buttons'); // New
const likeBtn = document.getElementById('like-btn'); // New
const dislikeBtn = document.getElementById('dislike-btn'); // New
const footerDashboard = document.getElementById('footer-dashboard');
const recentInteractions = document.getElementById('recent-interactions');
const noInteractions = document.getElementById('no-interactions');
const articleTemplate = document.getElementById('article-template');

// === API CLIENT === (Unchanged from previous version)
class ApiClient { /* ... same ApiClient class ... */
    constructor() { this.apiKey = localStorage.getItem('whatsgood_api_key'); this.userId = localStorage.getItem('whatsgood_user_id'); }
    async login(key) { const res = await this.request('/login', 'POST', null, { api_key: key }); this.apiKey = key; this.userId = res.user_id; localStorage.setItem('whatsgood_api_key', key); localStorage.setItem('whatsgood_user_id', res.user_id); return res; }
    logout() { this.apiKey = null; this.userId = null; localStorage.removeItem('whatsgood_api_key'); localStorage.removeItem('whatsgood_user_id'); }
    isLoggedIn() { return !!this.apiKey; }
    async getMe() { return this.request('/me', 'GET'); }
    async setPersona(persona) { return this.request('/persona', 'POST', { user_id: this.userId, persona }); }
    async getRecommendations() { return this.request(`/recommendations?user_id=${this.userId}`, 'GET'); }
    async postInteraction(articleId, interactionType) { return this.request('/interact', 'POST', { user_id: this.userId, article_id: articleId, interaction_type: interactionType }); }
    async request(endpoint, method, body = null, unauthData = null) { const headers = { 'Content-Type': 'application/json' }; if (this.apiKey) { headers['x-api-key'] = this.apiKey; } const config = { method, headers }; if (body) { config.body = JSON.stringify(body); } else if (unauthData) { config.body = JSON.stringify(unauthData); } try { const response = await fetch(`${API_BASE_URL}${endpoint}`, config); if (!response.ok) { if (response.status === 403) { throw new Error("403"); } const errorData = await response.json().catch(() => ({ message: `HTTP error ${response.status}` })); throw new Error(errorData.message || `API request failed with status ${response.status}`); } return await response.json(); } catch (err) { console.error("API Request Error:", err); if (err.message === "403") { throw new Error("403"); } throw err; } }
}
const api = new ApiClient();

// === APP LOGIC ===

function initApp() {
    if (api.isLoggedIn()) {
        showDashboard();
    } else {
        showLogin();
    }
}

function showLogin() {
    dashboardScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
}

async function showDashboard() {
    loginScreen.classList.add('hidden');
    dashboardScreen.classList.remove('hidden');
    resetUIStates(); // Clear previous errors/loading

    try {
        const me = await api.getMe();
        api.userId = me.user_id; // Ensure userId is set
        renderRecentInteractions(me.recent_interactions);

        if (!me.base_persona) {
            personaSetup.classList.remove('hidden');
        } else {
            personaInput.value = me.base_persona; // Pre-fill in case they want to edit later?
            personaSetup.classList.add('hidden');
            recsContainer.classList.remove('hidden');
            footerDashboard.classList.remove('hidden');
            loadRecommendations();
        }
    } catch (err) {
        handleApiError(err, "loading your profile");
    }
}

function resetUIStates() {
    loadingSpinner.classList.add('hidden');
    endOfStack.classList.add('hidden');
    errorDisplay.classList.add('hidden');
    personaSetup.classList.add('hidden');
    recsContainer.classList.add('hidden');
    footerDashboard.classList.add('hidden');
}

async function handleLogin() {
    const key = apiKeyInput.value.trim();
    if (!key) return;
    loginError.textContent = "";
    loginBtn.disabled = true; loginBtn.textContent = 'Logging in...';

    try {
        await api.login(key);
        showDashboard();
    } catch (err) {
        loginError.textContent = (err.message === "403") ? "Invalid API Key." : "Login failed. Please try again.";
    } finally {
        loginBtn.disabled = false; loginBtn.textContent = 'Login';
    }
}

async function handleSavePersona() {
    const interest = interestInput.value.trim();
    const specificInterests = personaInput.value.trim();

    if (!interest || !specificInterests) {
        alert("Please fill in both interest fields.");
        return;
    }

    // Combine into a single persona string (adjust format as needed)
    const fullPersona = `Primary Interest: ${interest}. Specifics: ${specificInterests}`;

    savePersonaBtn.disabled = true; savePersonaBtn.textContent = 'Saving...';
    try {
        await api.setPersona(fullPersona);
        showDashboard(); // Reload dashboard to show recs
    } catch (err) {
        alert(`Error saving persona: ${err.message}`);
    } finally {
         savePersonaBtn.disabled = false; savePersonaBtn.textContent = 'Save & View Feed';
    }
}

async function loadRecommendations() {
    resetCardStackUI();
    loadingSpinner.classList.remove('hidden');
    cardCounter.textContent = '';

    try {
        const data = await api.getRecommendations();
        currentArticles = data.recommendations || [];
        currentCardIndex = 0;
        loadingSpinner.classList.add('hidden');

        if (currentArticles.length > 0) {
            renderCardStack();
        } else {
            showEndOfStack("No new recommendations found for your persona.");
        }
    } catch (err) {
        handleApiError(err, "fetching recommendations");
    }
}

function resetCardStackUI() {
    cardStack.innerHTML = ''; // Clear old cards
    endOfStack.classList.add('hidden');
    errorDisplay.classList.add('hidden');
    loadingSpinner.classList.remove('hidden'); // Show spinner initially
    swipeButtons.classList.add('hidden'); // Hide buttons until cards load
}

function renderCardStack() {
    if (currentArticles.length === 0) {
        showEndOfStack("No articles loaded.");
        return;
    }

    // Render cards in reverse order for stacking
    currentArticles.slice().reverse().forEach((article, index) => {
        const card = createCardElement(article);
        card.style.zIndex = currentArticles.length - 1 - index; // Correct z-index
        // Apply stack visual effect only to cards below the top one
        if (index > 0 && index < 3) { // Style the 2nd and 3rd card from top
             const scale = 1 - (index * 0.05);
             const translateY = index * -15;
             card.style.transform = `translateY(${translateY}px) scale(${scale})`;
             card.style.opacity = 1 - (index * 0.2);
        } else if (index >= 3) {
            card.style.display = 'none'; // Hide cards beyond the 3rd
        } else {
             card.style.transform = 'translateY(0) scale(1)'; // Top card style
             card.style.opacity = 1;
        }
        cardStack.appendChild(card);
    });

    updateCardCounter();
    swipeButtons.classList.remove('hidden'); // Show buttons

    const topCard = cardStack.lastChild;
    if (topCard) {
        initSwipe(topCard);
        topCard.classList.add('swipe-hint'); // Add glow to top card
    } else {
         showEndOfStack("You've viewed all recommendations for now.");
    }
}


function createCardElement(article) {
    const card = articleTemplate.content.cloneNode(true).firstElementChild;
    card.dataset.id = article.id;
    card.dataset.url = article.url;

    card.querySelector('.industry-tag').textContent = article.industry || 'General';
    card.querySelector('.published-date').textContent = new Date(article.published_date).toLocaleDateString();
    card.querySelector('.article-title').textContent = article.title;
    card.querySelector('.article-summary').textContent = article.summary;

    const reasonTooltip = card.querySelector('.reason-tooltip-trigger');
    reasonTooltip.dataset.tooltip = article.reason || 'No specific reason provided.';

    // Populate expanded view (Unchanged)
    const expandedContent = card.querySelector('.expanded-content');
    expandedContent.querySelector('.expanded-title').textContent = article.title; 
    expandedContent.querySelector('.expanded-summary').textContent = article.summary; 
    expandedContent.querySelector('.expanded-reason').textContent = article.reason || ''; 
    expandedContent.querySelector('.expanded-link').href = article.url; 

    card.querySelector('.card-content').addEventListener('click', () => { /* ... expand logic ... */ });
    card.querySelector('.close-expanded-btn').addEventListener('click', (e) => { /* ... close logic ... */ });

    return card;
}

function initSwipe(card) {
    if (!card || card.hammer) return; // Prevent multiple initializations

    card.hammer = new Hammer(card); // Store hammer instance on the element
    const screenWidth = window.innerWidth;

    card.hammer.get('pan').set({ direction: Hammer.DIRECTION_HORIZONTAL, threshold: 20 });

    card.hammer.on('panstart', () => {
        if (card.querySelector('.expanded-content').classList.contains('hidden')) {
            card.classList.add('dragging');
            card.classList.remove('swipe-hint'); // Remove glow on drag start
        }
    });

    card.hammer.on('panmove', (e) => {
        if (!card.classList.contains('dragging')) return;
        const rotation = e.deltaX * 0.05;
        card.style.transform = `translateX(${e.deltaX}px) rotate(${rotation}deg)`;
        const likeOpacity = e.deltaX > 0 ? Math.min(e.deltaX / (screenWidth / 4), 1) : 0;
        const dislikeOpacity = e.deltaX < 0 ? Math.min(Math.abs(e.deltaX) / (screenWidth / 4), 1) : 0;
        card.style.setProperty('--like-opacity', likeOpacity);
        card.style.setProperty('--dislike-opacity', dislikeOpacity);
    });

    card.hammer.on('panend', (e) => {
        card.classList.remove('dragging');
        card.style.setProperty('--like-opacity', 0);
        card.style.setProperty('--dislike-opacity', 0);

        const absDeltaX = Math.abs(e.deltaX);
        const velocityX = Math.abs(e.velocityX);

        // Decide swipe based on distance OR velocity
        if (absDeltaX > 100 || (absDeltaX > 50 && velocityX > 0.5)) {
            const direction = e.deltaX > 0 ? 'right' : 'left';
            animateSwipe(card, direction);
        } else {
            // Return to stack visual position
             const stackIndex = Array.from(cardStack.children).indexOf(card);
             const visualIndex = currentArticles.length - 1 - stackIndex - currentCardIndex; // How many cards are visually below it
             resetCardPosition(card, visualIndex);
        }
    });
}

function animateSwipe(card, direction) {
    const screenWidth = window.innerWidth;
    const interaction = direction === 'right' ? 'like' : 'dislike';

    card.style.transition = 'transform 0.4s ease-out, opacity 0.4s ease-out'; // Faster exit
    card.style.transform = `translateX(${direction === 'right' ? screenWidth : -screenWidth}px) rotate(${direction === 'right' ? 20 : -20}deg)`;
    card.style.opacity = 0;

    // Destroy Hammer instance to prevent memory leaks
    if (card.hammer) {
        card.hammer.destroy();
        card.hammer = null;
    }

    handleSwipeAction(card.dataset.id, interaction);

    setTimeout(() => {
        card.remove();
        currentCardIndex++; // Increment index AFTER swipe completes
        updateCardCounter();
        updateStackAppearance();

        const nextCard = cardStack.lastChild; // The new top card
        if (nextCard) {
            initSwipe(nextCard); // Init swipe on the NEW top card
            nextCard.classList.add('swipe-hint'); // Add glow
        } else {
            showEndOfStack("You've viewed all recommendations for this session.");
        }
    }, 400); // Match transition duration
}

function resetCardPosition(card, visualIndex) {
     if (visualIndex <= 0) { // Top card
         card.style.transform = 'translateY(0) scale(1)';
         card.style.opacity = 1;
         card.classList.add('swipe-hint'); // Re-add glow if returned
     } else if (visualIndex < 3) { // 2nd or 3rd card
         const scale = 1 - (visualIndex * 0.05);
         const translateY = visualIndex * -15;
         card.style.transform = `translateY(${translateY}px) scale(${scale})`;
         card.style.opacity = 1 - (visualIndex * 0.2);
         card.classList.remove('swipe-hint');
     } else { // Cards further down (shouldn't be visible but reset anyway)
         card.style.display = 'none';
         card.classList.remove('swipe-hint');
     }
}

function updateStackAppearance() {
    const cards = Array.from(cardStack.children).reverse(); // Get cards top to bottom
    cards.forEach((card, visualIndex) => {
        if (visualIndex === 0) { // Top card
            card.style.transform = 'translateY(0) scale(1)';
            card.style.opacity = 1;
            card.style.display = 'flex';
        } else if (visualIndex < 3) { // 2nd and 3rd visible cards
            const scale = 1 - (visualIndex * 0.05);
            const translateY = visualIndex * -15;
            card.style.transform = `translateY(${translateY}px) scale(${scale})`;
            card.style.opacity = 1 - (visualIndex * 0.2);
            card.style.display = 'flex';
        } else { // Hide cards beyond 3rd
            card.style.display = 'none';
        }
    });
}


async function handleSwipeAction(articleId, interactionType) {
    console.log(`Swiped ${interactionType} on article ${articleId}`);
    try {
        await api.postInteraction(articleId, interactionType);
        // Refresh recent interactions in the footer immediately
        const me = await api.getMe();
        renderRecentInteractions(me.recent_interactions);
    } catch (err) {
        // Don't block UI for this, just log it
        console.error(`Failed to post interaction: ${err.message}`);
        // Optionally show a small toast message here?
    }
}

function renderRecentInteractions(interactions) {
    recentInteractions.innerHTML = '';
    if (!interactions || interactions.length === 0) {
        noInteractions.classList.remove('hidden');
        return;
    }
    noInteractions.classList.add('hidden');
    interactions.forEach(item => { /* ... same rendering logic ... */ });
}

function updateCardCounter() {
    const remaining = currentArticles.length - currentCardIndex;
    if (remaining > 0) {
        cardCounter.textContent = `Card ${currentCardIndex + 1} of ${currentArticles.length}`;
    } else {
        cardCounter.textContent = '';
    }
}

function showEndOfStack(message) {
    endOfStackMessage.textContent = message || "You've seen all recommendations for now. Check back later or refresh.";
    endOfStack.classList.remove('hidden');
    swipeButtons.classList.add('hidden'); // Hide buttons when stack is empty
}

function handleApiError(err, context) {
    console.error(`API Error (${context}):`, err);
    loadingSpinner.classList.add('hidden');
    swipeButtons.classList.add('hidden');

    if (err.message === "403") {
        // Quota exceeded or invalid key after login
        showEndOfStack("You've reached your daily limit (10 refreshes/day). Please try again tomorrow.");
        // Optionally log the user out if the key might be invalid
        // api.logout(); showLogin();
    } else {
        // Generic error
        errorMessage.textContent = `Failed ${context}. ${err.message}.`;
        errorDisplay.classList.remove('hidden');
    }
}

// === BOOTSTRAP / EVENT LISTENERS ===
loginBtn.addEventListener('click', handleLogin);
savePersonaBtn.addEventListener('click', handleSavePersona);
refreshBtn.addEventListener('click', loadRecommendations);
retryBtn.addEventListener('click', loadRecommendations); // Retry button calls loadRecommendations
logoutBtn.addEventListener('click', () => { api.logout(); showLogin(); });

likeBtn.addEventListener('click', () => {
    const topCard = cardStack.lastChild;
    if (topCard) animateSwipe(topCard, 'right');
});
dislikeBtn.addEventListener('click', () => {
    const topCard = cardStack.lastChild;
    if (topCard) animateSwipe(topCard, 'left');
});

// Start the app
initApp();
</script>
</body>
</html>